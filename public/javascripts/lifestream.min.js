function call_rest(url,callback){var xhttp=new XMLHttpRequest;xhttp.addEventListener("load",callback),xhttp.addEventListener("error",function(){console.log("Request to "+url+" failed")}),xhttp.open("GET",url,!0),xhttp.send()}function get_entries(feed,callback){call_rest(feed.url,function(){callback(feed.parser(JSON.parse(this.responseText)))})}function get_link(href,text){return a=document.createElement("a"),a.setAttribute("href",href),a.textContent=text,a.outerHTML}function get_repo_url(entry){return"https://github.com/"+entry.repo.name}function get_repo_link(entry){return get_link(get_repo_url(entry),entry.repo.name)}var parse_pocket=function(res){var entries=[];return res.query.results.rss.channel.item.forEach(function(entry){entries.push({name:"pocket",date:new Date(entry.pubDate),html:"read "+get_link(entry.link,entry.title),url:"https://getpocket.com/@efang"})}),entries},parse_github=function(res){var entries=[];return res.forEach(function(entry){var html="";"CommitCommentEvent"===entry.type?html="commented on "+get_repo_link(entry):"CreateEvent"===entry.type&&"branch"===entry.payload.ref_type?html="created branch "+get_link(get_repo_url(entry)+"/tree/"+entry.payload.ref,entry.payload.ref)+" at "+get_repo_link(entry):"CreateEvent"===entry.type&&"repository"===entry.payload.ref_type?html="created repository "+get_repo_link(entry):"CreateEvent"===entry.type&&"tag"===entry.payload.ref_type?html="created tag "+get_link(get_repo_url(entry)+"/tree/"+entry.payload.ref,entry.payload.ref)+" at "+get_repo_link(entry):"DeleteEvent"===entry.type&&"branch"===entry.payload.ref_type?html="deleted branch "+entry.payload.ref+" at "+get_repo_link(entry):"DeleteEvent"===entry.type&&"tag"===entry.payload.ref_type?html="deleted tag "+entry.payload.ref+" at "+get_repo_link(entry):"FollowEvent"===entry.type?html="started following "+get_link("https://github.com/"+entry.payload.target.login,entry.payload.target.login):"ForkEvent"===entry.type?html="forked "+get_repo_link(entry):"GistEvent"===entry.type?("create"===entry.payload.action?entry.payload.action="created":"update"===entry.payload.action&&(entry.payload.action="updated"),html=entry.payload.action+" gist "+get_link("https://gist.github.com/"+entry.payload.gist.id,entry.payload.gist.id)):"IssueCommentEvent"===entry.type?html="commented on issue "+get_link(get_repo_url(entry)+"/issues/"+entry.payload.issue.number,entry.payload.issue.number)+" on "+get_repo_link(entry):"IssuesEvent"===entry.type?html=entry.payload.action+" issue "+get_link(get_repo_url(entry)+"/issues/"+entry.payload.issue.number,entry.payload.issue.number)+" on "+get_repo_link(entry):"PullRequestEvent"===entry.type?html=entry.payload.action+" pull request "+get_link(get_repo_url(entry)+"/pull/"+entry.payload.number,entry.payload.number)+" on "+get_repo_link(entry):"PushEvent"===entry.type?(entry.payload.ref=entry.payload.ref.split("/")[2],html="pushed to "+get_link(get_repo_url(entry)+"/tree/"+entry.payload.ref,entry.payload.ref)+" at "+get_repo_link(entry)):"WatchEvent"===entry.type&&(html="started watching "+get_repo_link(entry)),entries.push({name:"github",date:new Date(entry.created_at),html:html,url:"https://github.com/etano"})}),entries},linkify=function(tweet){return function(t){return t.replace(/<a.*?<\/a>|(^|\r?\n|\r|\n|)(#|\$)([a-zA-Z0-9ÅåÄäÖöØøÆæÉéÈèÜüÊêÛûÎî_]+)(\r?\n|\r|\n||$)/g,function(m,m1,m2,m3,m4){if(void 0===m3)return m;var elem="";return"#"==m2?elem=get_link("https://twitter.com/hashtag/"+m3+"?src=hash","#"+m3):"$"==m2&&(elem=get_link("https://twitter.com/search?q=%24"+m3+"&src=hash","#"+m3)),m1+elem+m4})}(function(t){return t.replace(/(^|[^\w]+)\@([a-zA-Z0-9_]{1,15})/g,function(m,m1,m2){return m1+get_link("https://twitter.com/"+m2,"@"+m2)})}(function(t){return t.replace(/([a-z]+:\/\/)([-A-Z0-9+&@#\/%?=~_|(\)!:,.;]*[-A-Z0-9+&@#\/%=~_|(\)])/gi,function(m,m1,m2){return get_link(m,m2.length>35?m2.substr(0,34)+"...":m2)})}(tweet)))},parse_twitter=function(res){var entries=[];return res.tweets.forEach(function(entry){entries.push({name:"twitter",date:new Date(1e3*entry.createdAt),html:"tweeted "+linkify(entry.text),url:"https://twitter.com/ethanwbrown/status/"+entry.id})}),entries},feeds=[{name:"github",url:"https://api.github.com/users/etano/events?page=1&per_page=300",parser:parse_github},{name:"pocket",url:"https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20xml%20where%20url%3D%22http%3A%2F%2Fwww.getpocket.com%2Fusers%2Fefang%2Ffeed%2Fall%2F%22&format=json&callback=",parser:parse_pocket},{name:"twitter",url:"https://twittery.herokuapp.com/ethanwbrown",parser:parse_twitter}],one_week_ago=new Date;one_week_ago.setDate(one_week_ago.getDate()-7);var all_entries=[];feeds.forEach(function(feed){get_entries(feed,function(entries){entries.forEach(function(entry){all_entries.push(entry)}),all_entries.sort(function(a,b){return b.date-a.date});for(var ul=document.getElementById("lifestream");ul.firstChild;)ul.removeChild(ul.firstChild);for(var i=0;i<all_entries.length;i++)if(all_entries[i].date>one_week_ago){var date=document.createElement("span");date.textContent=timeago().format(all_entries[i].date),date.setAttribute("id","date");var source=document.createElement("span"),a=document.createElement("a");a.textContent=all_entries[i].name,a.setAttribute("href",all_entries[i].url),source.appendChild(a),source.setAttribute("id","source");var html=document.createElement("span");html.innerHTML=all_entries[i].html,html.setAttribute("id","html");var li=document.createElement("li");li.appendChild(html),li.appendChild(source),li.appendChild(date),ul.appendChild(li)}})});
